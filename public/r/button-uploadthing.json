{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "button-uploadthing",
  "type": "registry:component",
  "title": "Uploadthing Button",
  "description": "Workflow: Inside the uploadthing's admin dashboard",
  "dependencies": [
    "zustand",
    "uploadthing",
    "@uploadthing/react",
    "@uploadthing/shared",
    "paralleldrive/cuid2",
    "lucide-react"
  ],
  "registryDependencies": [
    "button",
    "sonner"
  ],
  "files": [
    {
      "path": "registry/new-york/button-uploadthing/button-uploadthing.tsx",
      "content": "//////////////////////////////////////////////////////////////////////////////////\r\n// UTUIButtonUploadthing\r\n//////////////////////////////////////////////////////////////////////////////////\r\n\r\n\"use client\";\r\n\r\n// Global Imports\r\nimport { createId } from \"@paralleldrive/cuid2\";\r\nimport { CircleCheck, GripVertical, Info } from \"lucide-react\";\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport { toast } from \"sonner\";\r\nimport { generatePermittedFileTypes } from \"uploadthing/client\";\r\n\r\n// Local Imports\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { useUploadThing } from \"@/lib/uploadthing\";\r\nimport {\r\n  UTUIFileStatus,\r\n  UTUIFunctionsProps,\r\n  UTUIUploadFile,\r\n} from \"@/lib/uploadthing-ui-types\";\r\nimport { useUploadthingStore } from \"@/store/button-uploadthing-store\";\r\n\r\n// Body\r\nexport default function UTUIButtonUploadthing({\r\n  UTUIFunctionsProps,\r\n}: {\r\n  UTUIFunctionsProps: UTUIFunctionsProps;\r\n}) {\r\n  // [1] Refs & States\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const { setFiles, historicFiles } = useUploadthingStore();\r\n\r\n  // [2] Deriving the accepted file types\r\n  const { routeConfig } = useUploadThing(UTUIFunctionsProps.fileRoute);\r\n  const acceptedFileTypes = generatePermittedFileTypes(routeConfig)\r\n    .fileTypes.map((fileType) => {\r\n      if (fileType.includes(\"/\")) {\r\n        return fileType;\r\n      } else {\r\n        return `${fileType}/*`;\r\n      }\r\n    })\r\n    .join(\",\");\r\n\r\n  // [3] Handlers\r\n  const handleButtonClick = () => {\r\n    fileInputRef.current?.click();\r\n  };\r\n\r\n  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const selectedFiles = e.target.files;\r\n    if (selectedFiles && selectedFiles.length > 0) {\r\n      // Convert FileList to Array and add to store\r\n      setFiles(\r\n        Array.from(selectedFiles).map((fileObj) => ({\r\n          file: fileObj,\r\n          id: createId(),\r\n          fileObj,\r\n          status: \"pending\" as UTUIFileStatus, // Use type assertion here\r\n          createdAt: new Date(),\r\n        })),\r\n      );\r\n\r\n      // Reset the input to allow selecting the same files again\r\n      if (fileInputRef.current) {\r\n        fileInputRef.current.value = \"\";\r\n      }\r\n    }\r\n  };\r\n\r\n  // [4] JSX\r\n  return (\r\n    <div className=\"flex flex-col gap-8 text-sm\">\r\n      <div>\r\n        <input\r\n          type=\"file\"\r\n          ref={fileInputRef}\r\n          onChange={handleFileChange}\r\n          style={{ display: \"none\" }}\r\n          multiple\r\n          accept={acceptedFileTypes}\r\n        />\r\n        <Button className=\"w-fit\" onClick={handleButtonClick}>\r\n          Select Files to Upload\r\n        </Button>\r\n      </div>\r\n\r\n      {historicFiles.map((fileObj) => (\r\n        <DisplayingToasts\r\n          key={fileObj.id}\r\n          uploadFile={fileObj}\r\n          UTUIFunctionsProps={UTUIFunctionsProps}\r\n        />\r\n      ))}\r\n    </div>\r\n  );\r\n}\r\n\r\n//////////////////////////////////////////////////////////////////////////////////\r\n// Displaying Toasts\r\n//////////////////////////////////////////////////////////////////////////////////\r\n\r\nfunction DisplayingToasts({\r\n  uploadFile,\r\n  UTUIFunctionsProps,\r\n}: {\r\n  uploadFile: UTUIUploadFile;\r\n  UTUIFunctionsProps: UTUIFunctionsProps;\r\n}) {\r\n  // [1] Refs & States\r\n  const isMounted = useRef(true);\r\n  const hasStartedUpload = useRef(false);\r\n  const [progress, setProgress] = useState(0);\r\n  const [toastId, setToastId] = useState<string | number | undefined>(\r\n    undefined,\r\n  );\r\n  const { updateFileStatus, removeFile } = useUploadthingStore();\r\n\r\n  // [2] Uploadthing\r\n  const { startUpload, isUploading } = useUploadThing(\r\n    UTUIFunctionsProps.fileRoute,\r\n    {\r\n      uploadProgressGranularity: \"fine\",\r\n      onUploadProgress: (progress) => {\r\n        if (isMounted.current) {\r\n          setProgress(progress);\r\n\r\n          // Your additional code here\r\n          UTUIFunctionsProps.onUploadProgress?.(progress);\r\n        }\r\n      },\r\n      onClientUploadComplete: (res) => {\r\n        if (isMounted.current && res?.[0]) {\r\n          updateFileStatus(uploadFile.id, \"complete\", res[0].url);\r\n\r\n          // Your additional code here\r\n          UTUIFunctionsProps.onClientUploadComplete?.(res);\r\n        }\r\n      },\r\n      onUploadError: (error) => {\r\n        if (isMounted.current) {\r\n          updateFileStatus(uploadFile.id, \"error\");\r\n\r\n          // Your additional code here\r\n          UTUIFunctionsProps.onUploadError?.(error);\r\n        }\r\n      },\r\n      onBeforeUploadBegin: UTUIFunctionsProps.onBeforeUploadBegin,\r\n      onUploadBegin: UTUIFunctionsProps.onUploadBegin,\r\n    },\r\n  );\r\n\r\n  // [3] Effects\r\n  // When a file isn't uploading\r\n  useEffect(() => {\r\n    if (!hasStartedUpload.current && !isUploading) {\r\n      hasStartedUpload.current = true;\r\n\r\n      startUpload([uploadFile.file]);\r\n      updateFileStatus(uploadFile.id, \"uploading\");\r\n\r\n      // Adding a toast for the upload\r\n      setToastId(\r\n        toast.custom(\r\n          () => <ToastComponent progress={progress} uploadFile={uploadFile} />,\r\n          {\r\n            duration: Infinity,\r\n          },\r\n        ),\r\n      );\r\n\r\n      return;\r\n    }\r\n  }, [\r\n    uploadFile,\r\n    progress,\r\n    isUploading,\r\n    hasStartedUpload,\r\n    startUpload,\r\n    updateFileStatus,\r\n    setToastId,\r\n  ]);\r\n\r\n  // When a file changes its status during the uploading process\r\n  useEffect(() => {\r\n    if (uploadFile.status === \"complete\" && toastId) {\r\n      toast.custom(() => <ToastComponentCompleted uploadFile={uploadFile} />, {\r\n        id: toastId,\r\n        duration: 4000,\r\n      });\r\n\r\n      // Removing file from state\r\n      removeFile(uploadFile.id);\r\n\r\n      return;\r\n    }\r\n\r\n    if (uploadFile.status === \"error\" && toastId) {\r\n      toast.custom(() => <ToastComponentError uploadFile={uploadFile} />, {\r\n        id: toastId,\r\n        duration: 4000,\r\n      });\r\n\r\n      return;\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [uploadFile, toastId, toast, removeFile]);\r\n\r\n  // When a file starts its uploading process\r\n  useEffect(() => {\r\n    if (toastId && isUploading) {\r\n      // Update the progress inside the toast\r\n      toast.custom(\r\n        () => <ToastComponent progress={progress} uploadFile={uploadFile} />,\r\n        { id: toastId },\r\n      );\r\n    }\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [progress, toastId, isUploading]);\r\n\r\n  return <div className=\"hidden\">{uploadFile.id}</div>;\r\n}\r\n\r\nfunction ToastComponent({\r\n  progress,\r\n  uploadFile,\r\n}: {\r\n  progress: number;\r\n  uploadFile: UTUIUploadFile;\r\n}) {\r\n  return (\r\n    <div className=\"flex h-16 w-full select-none items-center gap-4 rounded-md border px-4 text-xs shadow-lg sm:w-96\">\r\n      <div className=\"min-w-11\">\r\n        <CircularProgressBar percentage={progress} />\r\n      </div>\r\n      <p className=\"truncate\">Uploading {uploadFile.file.name}</p>\r\n      <GripVertical className=\"ml-auto min-w-10 stroke-1\" />\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ToastComponentCompleted({\r\n  uploadFile,\r\n}: {\r\n  uploadFile: UTUIUploadFile;\r\n}) {\r\n  return (\r\n    <div className=\"flex h-16 w-full select-none items-center gap-4 rounded-md border px-4 text-xs shadow-lg sm:w-96\">\r\n      <CircleCheck className=\"min-w-6 fill-foreground stroke-background stroke-1\" />\r\n      <div className=\"flex flex-col truncate\">\r\n        <p className=\"truncate\">File uploaded successfully!</p>\r\n        <p className=\"truncate\">Uploaded {uploadFile.file.name}</p>\r\n      </div>\r\n      <GripVertical className=\"ml-auto min-w-10 stroke-1\" />\r\n    </div>\r\n  );\r\n}\r\n\r\nfunction ToastComponentError({ uploadFile }: { uploadFile: UTUIUploadFile }) {\r\n  return (\r\n    <div className=\"flex h-16 w-full select-none items-center gap-4 truncate rounded-md border px-4 text-xs shadow-lg sm:w-96\">\r\n      <Info className=\"min-w-6 fill-foreground stroke-background stroke-1\" />\r\n      <div className=\"flex flex-col truncate\">\r\n        <p className=\"truncate\">File couldn&apos;t be uploaded</p>\r\n        <p className=\"truncate\">{uploadFile.file.name}</p>\r\n      </div>\r\n      <GripVertical className=\"ml-auto min-w-10 stroke-1\" />\r\n    </div>\r\n  );\r\n}\r\n\r\n//////////////////////////////////////////////////////////////////////////////////\r\n// Circular Progress Bar\r\n//////////////////////////////////////////////////////////////////////////////////\r\n\r\nfunction CircularProgressBar({ percentage }: { percentage: number }) {\r\n  // [1] JSX\r\n  return (\r\n    <div className=\"relative\">\r\n      <svg\r\n        className=\"-rotate-90\"\r\n        viewBox=\"0 0 36 36\"\r\n        xmlns=\"http://www.w3.org/2000/svg\"\r\n      >\r\n        <circle\r\n          cx=\"18\"\r\n          cy=\"18\"\r\n          r=\"16\"\r\n          fill=\"none\"\r\n          className=\"stroke-current stroke-2 text-primary\"\r\n        ></circle>\r\n        <circle\r\n          cx=\"18\"\r\n          cy=\"18\"\r\n          r=\"16\"\r\n          fill=\"none\"\r\n          className=\"stroke-current stroke-2 text-secondary\"\r\n          strokeDasharray=\"100\"\r\n          strokeDashoffset={percentage}\r\n          strokeLinecap=\"round\"\r\n        ></circle>\r\n      </svg>\r\n      <div className=\"absolute start-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 transform\">\r\n        <span className=\"text-center text-xs text-primary\">{percentage}</span>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n",
      "type": "registry:component",
      "target": "components/uploadthing-ui/button-uploadthing.tsx"
    },
    {
      "path": "store/button-uploadthing-store.ts",
      "content": "// Global Imports\r\n\r\nimport { UTUIFileStatus, UTUIUploadFile } from \"@/lib/uploadthing-ui-types\";\r\nimport { create } from \"zustand\";\r\n\r\n// Local Imports\r\n\r\n// Body\r\n\r\ninterface FilesState {\r\n  historicFiles: UTUIUploadFile[];\r\n  setFiles: (newFiles: UTUIUploadFile[]) => void;\r\n  updateFileStatus: (id: string, status: UTUIFileStatus, url?: string) => void;\r\n  removeFile: (id: string) => void;\r\n}\r\n\r\nexport const useUploadthingStore = create<FilesState>()((set) => ({\r\n  historicFiles: [],\r\n  setFiles: (newFiles) =>\r\n    set((state) => {\r\n      // Check if the file is already in the historicFiles array. If not, add it as well\r\n      const newHistoricFiles = Array.from(newFiles).filter(\r\n        (file) =>\r\n          !state.historicFiles.some(\r\n            (historicFile) => historicFile.id === file.id,\r\n          ),\r\n      );\r\n\r\n      return {\r\n        historicFiles: [...state.historicFiles, ...newHistoricFiles],\r\n      };\r\n    }),\r\n  updateFileStatus: (id, status, url) =>\r\n    set((state) => ({\r\n      historicFiles: state.historicFiles.map((item) =>\r\n        item.id === id ? { ...item, status, url } : item,\r\n      ),\r\n    })),\r\n  removeFile: (id) =>\r\n    set((state) => ({\r\n      historicFiles: state.historicFiles.filter((item) => item.id !== id),\r\n    })),\r\n}));\r\n",
      "type": "registry:file",
      "target": "store/button-uploadthing-store.ts"
    },
    {
      "path": "lib/uploadthing-ui-types.ts",
      "content": "import { Json, MaybePromise, UploadThingError } from \"@uploadthing/shared\";\r\nimport { ClientUploadedFileData, EndpointArg } from \"uploadthing/types\";\r\n\r\nexport type UTUIFileStatus = \"pending\" | \"uploading\" | \"complete\" | \"error\";\r\n\r\nexport interface UTUIUploadFile {\r\n  id: string;\r\n  file: File;\r\n  status: UTUIFileStatus;\r\n  url?: string;\r\n  createdAt: Date;\r\n}\r\n\r\nexport interface UTUIFunctionsProps {\r\n  // eslint-disable-next-line @typescript-eslint/no-explicit-any\r\n  fileRoute: EndpointArg<any, any>;\r\n  onUploadProgress?: (progress: number) => void;\r\n  onClientUploadComplete?:\r\n    | ((\r\n        res: ClientUploadedFileData<{\r\n          uploadedBy: string;\r\n        }>[],\r\n      ) => MaybePromise<void>)\r\n    | undefined;\r\n  onUploadError?: (error: UploadThingError<Json>) => void;\r\n  onBeforeUploadBegin?:\r\n    | ((files: File[]) => Promise<File[]> | File[])\r\n    | undefined;\r\n  onUploadBegin?: ((fileName: string) => void) | undefined;\r\n}\r\n",
      "type": "registry:file",
      "target": "lib/uploadthing-ui-types.ts"
    },
    {
      "path": "lib/uploadthing-ui-utils.ts",
      "content": "import { ExpandedRouteConfig, FileRouterInputKey } from \"@uploadthing/shared\";\r\n\r\n// Converts the size into readable format\r\nexport function formatBytes(bytes: number, decimals = 1) {\r\n  if (bytes === 0) return \"0 B\";\r\n  if (bytes < 0) return \"Invalid size\";\r\n\r\n  const k = 1024;\r\n  const dm = decimals < 0 ? 0 : decimals;\r\n  const sizes = [\"B\", \"KB\", \"MB\", \"GB\", \"TB\", \"PB\", \"EB\", \"ZB\", \"YB\"];\r\n\r\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\r\n\r\n  return `${parseFloat((bytes / k ** i).toFixed(dm))} ${sizes[i]}`;\r\n}\r\n\r\n// Return the amount of file uploaded\r\nexport function getUploadedAmount(progress: number, fileSize: number) {\r\n  const uploadedAmount = (progress / 100) * fileSize;\r\n  return formatBytes(uploadedAmount);\r\n}\r\n\r\n// Capitalize the first letter\r\nexport function capitalizeFirstLetter(string: string) {\r\n  return string.charAt(0).toUpperCase() + string.slice(1);\r\n}\r\n\r\n// Return the objects value\r\nexport function checkFileObjectKey({\r\n  str,\r\n  obj,\r\n}: {\r\n  str: FileRouterInputKey | undefined;\r\n  obj: ExpandedRouteConfig | undefined;\r\n}) {\r\n  if (!str || !obj) return null;\r\n\r\n  if (obj && typeof obj === \"object\" && obj.hasOwnProperty(str)) {\r\n    return obj[str];\r\n  } else {\r\n    return null;\r\n  }\r\n}\r\n",
      "type": "registry:file",
      "target": "lib/uploadthing-ui-utils.ts"
    }
  ]
}